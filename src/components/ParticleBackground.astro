---
interface Props {
  particleCount?: number;
}

const { particleCount = 18 } = Astro.props;
---

<canvas id="particle-canvas" class="fixed inset-0 -z-10"></canvas>

<script is:inline define:vars={{ particleCount }}>
  const canvas = document.getElementById('particle-canvas');
  const ctx = canvas.getContext('2d');

  let particles = [];
  let animationId;
  let mouseX = 0;
  let mouseY = 0;
  let time = 0;
  const isMobile = window.matchMedia('(max-width: 768px)').matches;
  const count = isMobile ? Math.floor(particleCount * 0.5) : particleCount;

  function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }

  function createParticle() {
    // Depth creates sense of distance - some stars are far, some closer
    const depth = Math.random();
    // Slight bias toward smaller/dimmer for more "distant" feel
    const adjustedDepth = depth * depth;

    return {
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      // Larger base size, more variation - 1.5px to 4px
      size: adjustedDepth * 2.5 + 1.5,
      // Much slower drift - barely perceptible movement
      speedX: (Math.random() - 0.5) * 0.02,
      speedY: (Math.random() - 0.5) * 0.015 - 0.008, // slight upward drift
      // Opacity range for depth - dim but visible
      baseOpacity: adjustedDepth * 0.25 + 0.08,
      depth: adjustedDepth,
      // Individual pulse offset for organic feel
      pulseOffset: Math.random() * Math.PI * 2,
      pulseSpeed: 0.0003 + Math.random() * 0.0004,
    };
  }

  function init() {
    resize();
    particles = [];
    for (let i = 0; i < count; i++) {
      particles.push(createParticle());
    }
  }

  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    time++;

    particles.forEach((p) => {
      // Subtle parallax on desktop - closer particles move more
      let offsetX = 0;
      let offsetY = 0;
      if (!isMobile) {
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        offsetX = (mouseX - centerX) * 0.02 * p.depth;
        offsetY = (mouseY - centerY) * 0.02 * p.depth;
      }

      // Slow drift
      p.x += p.speedX;
      p.y += p.speedY;

      // Wrap around edges with buffer
      if (p.x < -10) p.x = canvas.width + 10;
      if (p.x > canvas.width + 10) p.x = -10;
      if (p.y < -10) p.y = canvas.height + 10;
      if (p.y > canvas.height + 10) p.y = -10;

      // Gentle pulse/twinkle - very subtle brightness variation
      const pulse = Math.sin(time * p.pulseSpeed + p.pulseOffset) * 0.15 + 1;
      const opacity = p.baseOpacity * pulse;

      // Draw with soft glow for larger particles
      const drawX = p.x + offsetX;
      const drawY = p.y + offsetY;

      // Soft glow layer for depth
      if (p.size > 2) {
        const gradient = ctx.createRadialGradient(
          drawX,
          drawY,
          0,
          drawX,
          drawY,
          p.size * 2
        );
        gradient.addColorStop(0, `rgba(200, 210, 255, ${opacity * 0.3})`);
        gradient.addColorStop(1, 'rgba(200, 210, 255, 0)');
        ctx.beginPath();
        ctx.arc(drawX, drawY, p.size * 2, 0, Math.PI * 2);
        ctx.fillStyle = gradient;
        ctx.fill();
      }

      // Core point - slightly blue-white tint
      ctx.beginPath();
      ctx.arc(drawX, drawY, p.size * 0.6, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(220, 225, 255, ${opacity})`;
      ctx.fill();
    });

    animationId = requestAnimationFrame(animate);
  }

  function handleMouseMove(e) {
    mouseX = e.clientX;
    mouseY = e.clientY;
  }

  // Initialize
  init();
  animate();

  // Event listeners
  window.addEventListener('resize', init);
  if (!isMobile) {
    window.addEventListener('mousemove', handleMouseMove);
  }

  // Cleanup on page leave (for Astro view transitions)
  document.addEventListener('astro:before-swap', () => {
    cancelAnimationFrame(animationId);
    window.removeEventListener('resize', init);
    window.removeEventListener('mousemove', handleMouseMove);
  });
</script>
